<button matButton="outlined" (click)="fileImport.click()">
  Import File<mat-icon>upload</mat-icon>
</button>
<input
  hidden
  #fileImport
  type="file"
  accept=".owsave,.json,application/json"
  (change)="openFile($event)"
/>

<form [formGroup]="form" (ngSubmit)="saveFile()">
  <mat-form-field>
    <mat-label><code>loopCount</code></mat-label>
    <input matInput formControlName="loopCount" type="number" step="1" />
  </mat-form-field>

  <mat-accordion multi>
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title><code>knownFrequencies</code></mat-panel-title>
      </mat-expansion-panel-header>

      <fieldset formArrayName="knownFrequencies">
        @for (
          _ of knownFrequencies.controls.slice(0, vanillaFrequencies.length);
          track vanillaFrequencies[$index][0]
        ) {
          <mat-slide-toggle [formControlName]="$index"
            >{{ vanillaFrequencies[$index][0] }}
            <span class="hint"
              >{{ vanillaFrequencies[$index][1] }} ({{ $index }})</span
            ></mat-slide-toggle
          >
        }
        @for (_ of knownFrequencies.controls.slice(vanillaFrequencies.length); track $index) {
          <div>
            <mat-slide-toggle [formControlName]="$index + vanillaFrequencies.length"
              >Custom Frequency
              <span class="hint">({{ $index + vanillaFrequencies.length }})</span></mat-slide-toggle
            >
            <button
              type="button"
              matIconButton
              (click)="removeAt(knownFrequencies, $index + vanillaFrequencies.length)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        }

        <button
          type="button"
          matButton
          (click)="knownFrequencies.push(fb.nonNullable.control(false))"
        >
          Add<mat-icon>add</mat-icon>
        </button>
      </fieldset>
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title><code>knownSignals</code></mat-panel-title>
      </mat-expansion-panel-header>

      hi
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title><code>dictConditions</code></mat-panel-title>
      </mat-expansion-panel-header>

      hi
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title><code>shipLogFactSaves</code></mat-panel-title>
      </mat-expansion-panel-header>

      hi
    </mat-expansion-panel>

    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title><code>newlyRevealedFactIDs</code></mat-panel-title>
      </mat-expansion-panel-header>

      <fieldset formArrayName="newlyRevealedFactIDs">
        @for (_ of newlyRevealedFactIDs.controls; track $index) {
          <div>
            <mat-form-field>
              <mat-label>Fact {{ $index + 1 }}</mat-label>
              <input
                matInput
                [formControlName]="$index"
                type="text"
                [matAutocomplete]="newlyRevealedFactIDsAutocomplete"
              />
              <mat-autocomplete #newlyRevealedFactIDsAutocomplete="matAutocomplete">
                @for (option of ((filteredFactIDs | async) ?? [])[$index] | async; track option) {
                  <mat-option [value]="option">{{ option }}</mat-option>
                }
              </mat-autocomplete>
            </mat-form-field>
            <button type="button" matIconButton (click)="removeAt(newlyRevealedFactIDs, $index)">
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        }

        <button
          type="button"
          matButton
          (click)="newlyRevealedFactIDs.push(fb.nonNullable.control(''))"
        >
          Add<mat-icon>add</mat-icon>
        </button>
      </fieldset>
    </mat-expansion-panel>
  </mat-accordion>

  <mat-form-field>
    <mat-label><code>lastDeathType</code></mat-label>
    <mat-select formControlName="lastDeathType">
      @for (deathType of deathTypes; track deathType) {
        <mat-option [value]="deathType.value"
          >{{ deathType.name }} <span class="hint">({{ deathType.value }})</span></mat-option
        >
      }
    </mat-select>
  </mat-form-field>

  <mat-form-field>
    <mat-label><code>burnedMarshmallowEaten</code></mat-label>
    <input matInput formControlName="burnedMarshmallowEaten" type="number" step="1" />
  </mat-form-field>

  <mat-form-field>
    <mat-label><code>fullTimeloops</code></mat-label>
    <input matInput formControlName="fullTimeloops" type="number" step="1" min="0" />
  </mat-form-field>

  <mat-form-field>
    <mat-label><code>perfectMarshmallowsEaten</code></mat-label>
    <input matInput formControlName="perfectMarshmallowsEaten" type="number" step="1" min="0" />
  </mat-form-field>

  <mat-slide-toggle formControlName="warpedToTheEye"><code>warpedToTheEye</code></mat-slide-toggle>

  <mat-form-field>
    <mat-label><code>secondsRemainingOnWarp</code></mat-label>
    <input matInput formControlName="secondsRemainingOnWarp" type="number" step="0.1" />
  </mat-form-field>

  <mat-form-field>
    <mat-label><code>loopCountOnParadox</code></mat-label>
    <input matInput formControlName="loopCountOnParadox" type="number" step="1" />
  </mat-form-field>

  <!-- TODO: multiselect with StartupPopups -->
  <mat-form-field>
    <mat-label><code>shownPopups</code></mat-label>
    <input matInput formControlName="shownPopups" type="number" step="1" />
  </mat-form-field>

  <mat-form-field>
    <mat-label><code>version</code></mat-label>
    <input matInput formControlName="version" type="text" />
  </mat-form-field>

  <mat-slide-toggle formControlName="ps5Activity_canResumeExpedition"
    ><code>ps5Activity_canResumeExpedition</code></mat-slide-toggle
  >

  <mat-accordion multi>
    <mat-expansion-panel>
      <mat-expansion-panel-header>
        <mat-panel-title><code>ps5Activity_availableShipLogCards</code></mat-panel-title>
      </mat-expansion-panel-header>

      <fieldset formArrayName="ps5Activity_availableShipLogCards">
        @for (_ of ps5Activity_availableShipLogCards.controls; track $index) {
          <div>
            <mat-form-field>
              <mat-label>Card {{ $index }}</mat-label>
              <input matInput [formControlName]="$index" type="text" />
            </mat-form-field>
            <button
              type="button"
              matIconButton
              (click)="removeAt(ps5Activity_availableShipLogCards, $index)"
            >
              <mat-icon>delete</mat-icon>
            </button>
          </div>
        }

        <button
          type="button"
          matButton
          (click)="ps5Activity_availableShipLogCards.push(fb.nonNullable.control(''))"
        >
          Add<mat-icon>add</mat-icon>
        </button>
      </fieldset>
    </mat-expansion-panel>
  </mat-accordion>

  <mat-slide-toggle formControlName="didRunInitGammaSetting"
    ><code>didRunInitGammaSetting</code></mat-slide-toggle
  >

  <button type="submit" matButton="filled" [disabled]="!form.valid">
    Export File<mat-icon>download</mat-icon>
  </button>
</form>
